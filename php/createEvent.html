<!DOCTYPE HTML>

<html>

<head>
    <title>Event erstellen</title>
    <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
    <script>
        var map,vectorLayer,selectMarkerControl,selectedFeature;
        var lat = 51.514;
        var lon = 7.463;
        var zoom = 15;
        var curpos = new Array();
        var position;
		
		var newLocMarker;
		var state = 0;
		
		var vectorLayer

        var fromProjection = new OpenLayers.Projection("EPSG:4326");   // Transform from WGS 1984
        var toProjection = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection

        var cntrposition = new OpenLayers.LonLat(lon, lat).transform( fromProjection, toProjection);
		
        function init() {
            map = new OpenLayers.Map("Map",{
				controls: 
					[
					new OpenLayers.Control.Navigation(),
					new OpenLayers.Control.PanZoomBar(),                        
					new OpenLayers.Control.LayerSwitcher({}),
					new OpenLayers.Control.ScaleLine(),
                    new OpenLayers.Control.OverviewMap(),
                    ]
                });
            var mapnik      = new OpenLayers.Layer.OSM("MAP"); 
            var markers     = new OpenLayers.Layer.Markers( "Markers" );
			vectorLayer = new OpenLayers.Layer.Vector("Overlay");
			
            map.addLayers([mapnik,markers,vectorLayer]);
            map.addLayer(mapnik);
            map.setCenter(cntrposition, zoom);
			
			var markerClick = {
				selector: new OpenLayers.Control.SelectFeature(vectorLayer, { onSelect: createPopup, onUnselect: destroyPopup })
			};
			
			map.addControl(markerClick['selector']);
			markerClick['selector'].activate();
			
            var click = new OpenLayers.Control.Click();
            map.addControl(click);

            click.activate();
		};

		OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {               
			defaultHandlerOptions: {
				'single': true,
				'double': false,
				'pixelTolerance': 0,
				'stopSingle': false,
				'stopDouble': false
				},

			initialize: function(options) {
				this.handlerOptions = OpenLayers.Util.extend(
					{}, this.defaultHandlerOptions
					);
				OpenLayers.Control.prototype.initialize.apply(
					this, arguments
					);
				this.handler = new OpenLayers.Handler.Click(
					this, {
						'click': this.trigger
					}, this.handlerOptions
					);
			},

			trigger: function(e) {
				var lonlat = map.getLonLatFromPixel(e.xy);
				lonlat1= new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(toProjection,fromProjection);
				document.getElementById("latitude").value = lonlat1.lat;
				document.getElementById("longitude").value = lonlat1.lon;
				if(state == 0){
					newLocMarker = placeMarker(lonlat1,'Test');
					state = 1;
				}else if (state == 1){
					newLocMarker.move(lonlat);
				}
				
			}
			/**
			
			
			
			*/
		});
		
		function applyLatLng(){
			var lon = document.getElementById("longitude").value;
			var lat = document.getElementById("latitude").value;
			map.setCenter((new OpenLayers.LonLat(lon, lat)).transform( fromProjection, toProjection), zoom);
		}
		
		function placeMarker(lonlat,popuptext){
			var feature = new OpenLayers.Feature.Vector(
				new OpenLayers.Geometry.Point( lonlat.lon,  lonlat.lat ).transform(fromProjection, toProjection),
				{description:popuptext} ,
				{externalGraphic: 'img/marker.png', graphicHeight: 25, graphicWidth: 21, graphicXOffset:-12, graphicYOffset:-25  }
				);    
			vectorLayer.addFeatures(feature);
			return feature;
		}
		
		function createPopup(feature) {
			feature.popup = new OpenLayers.Popup.FramedCloud("pop",
				feature.geometry.getBounds().getCenterLonLat(),
				null,
				'<div class="markerContent">'+feature.attributes.description+'</div>',
				null,
				true,
				function() { controls['selector'].unselectAll(); }
			);
			//feature.popup.closeOnMove = true;
			map.addPopup(feature.popup);
		}

		function destroyPopup(feature) {
			feature.popup.destroy();
			feature.popup = null;
		}
	</script>
	</head>

	<body onload='init();'>
		<div id= "formDiv">
			<form action="uploadEvent.php" id="event" method="post">
				<uol>
					<li>
						<label for="eventName">Eventname</label>
						<input type="text" name="eventName" id="eventName" maxLength="30">
					</li>
					<br>
					<li>
						<label for="price">Preis</label>
						<input type="number" name="price" id="price" min="0" max="128" step="0.01">
						<label> &#x20ac;</label>
					</li>
					<br>
					<li>
						<label for="participants">Maximale Teilnehmerzahl</label>
						<input type="number" name="participants" id="participants" min="1" max="2048">
					</li>
					<br>
					<li>
						<label>Datum und Zeit von</label>
						<input type="datetime-local" name="dateStart" id="dateStart" max="9999-12-31T23:59:59">
						<label>bis</label>
						<input type="datetime-local" name="dateEnd" id="dateEnd" max="9999-12-31T23:59:59">
					</li>
					<br>
					<li>
						<label for="description">Beschreibung</label>
						<textarea name="description" id="description"></textarea>
					</li>
					<br>
					<li>
						<label>Alter von</label>
						<input type="number" name="ageMin" id="ageMin" min="0" max="128">
						<label>bis</label>
						<input type="number" name="ageMax" id="ageMax" min="0" max="128">
					</li>
					<br>
					<li>
						<label for="address">Addresse</label>
						<input type="text" name="address" id="address" maxLength="30">
					</li>
					<br>
					<li>
						<label>Position</label>
						<input type="number" name="latitude" id="latitude" min="-180" max = "180" step="any">
						<input type="number" name="longitude" id="longitude" min="-180" max = "180" step="any">
						<a href="#" onClick="applyLatLng();">Anwenden</a>
						<br>
						<br>
						<div id="mapHeader">
							Karte: &#xa9;<a href="http://www.openstreetmap.org">OpenStreetMap</a>
							und <a href="http://www.openstreetmap.org/copyright">Mitwirkende</a>,
							<a href="http://creativecommons.org/licenses/by-sa/2.0/deed.de">CC-BY-SA</a>
						</div>
						<div id="Map" style="height:350px ; width:500px"></div>
					</li>
					<br>
					<li>
						<input type="submit" value="Event erstellen" class="btnSubmit" />
					</li>
				</uol>
			</form>
		</div>
	</body>
</html>